
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Deploying Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    


    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="03-memory-isnt-infinite.html" />
    
    
    <link rel="prev" href="01-computers-disappear.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../001-programming-a-backend/">
            
                <a href="../001-programming-a-backend/">
            
                    
                    Programming a backend
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../001-programming-a-backend/01-more-than-one-computer.html">
            
                <a href="../001-programming-a-backend/01-more-than-one-computer.html">
            
                    
                    More than one computer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../001-programming-a-backend/02-serving-an-api.html">
            
                <a href="../001-programming-a-backend/02-serving-an-api.html">
            
                    
                    Serving an API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../001-programming-a-backend/03-the-backends-backends.html">
            
                <a href="../001-programming-a-backend/03-the-backends-backends.html">
            
                    
                    The backend's backends
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../002-distributed-data/">
            
                <a href="../002-distributed-data/">
            
                    
                    Distributed data
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../002-distributed-data/01-contradictions.html">
            
                <a href="../002-distributed-data/01-contradictions.html">
            
                    
                    Contradictions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../002-distributed-data/02-persistent-state.html">
            
                <a href="../002-distributed-data/02-persistent-state.html">
            
                    
                    Persistent state
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../002-distributed-data/03-doing-things-later.html">
            
                <a href="../002-distributed-data/03-doing-things-later.html">
            
                    
                    Doing things later
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../002-distributed-data/04-operation-oriented-databases.html">
            
                <a href="../002-distributed-data/04-operation-oriented-databases.html">
            
                    
                    Operation-oriented databases
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="./">
            
                <a href="./">
            
                    
                    Backends in the wild
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="01-computers-disappear.html">
            
                <a href="01-computers-disappear.html">
            
                    
                    Computers disappear
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.2" data-path="02-deploying.html">
            
                <a href="02-deploying.html">
            
                    
                    Deploying
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="03-memory-isnt-infinite.html">
            
                <a href="03-memory-isnt-infinite.html">
            
                    
                    Memory isn't infinite
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="06-observability.html">
            
                <a href="06-observability.html">
            
                    
                    Observability
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../101-appendix-containers/">
            
                <a href="../101-appendix-containers/">
            
                    
                    Containers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../102-appendix-good-practices/">
            
                <a href="../102-appendix-good-practices/">
            
                    
                    Good Practices
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../102-appendix-good-practices/01-general-practices.html">
            
                <a href="../102-appendix-good-practices/01-general-practices.html">
            
                    
                    General Good Practices
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../102-appendix-good-practices/02-design-practices.html">
            
                <a href="../102-appendix-good-practices/02-design-practices.html">
            
                    
                    Design Good Practices
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../102-appendix-good-practices/99-polymorphism-and-abstract-types.html">
            
                <a href="../102-appendix-good-practices/99-polymorphism-and-abstract-types.html">
            
                    
                    Polymorphism and Abstract Types
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Deploying</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="deploying">Deploying</h1>
<h2 id="when-programs-fly-the-nest">When programs fly the nest</h2>
<p>The time comes for your little backend to go out there and <strong>serve a real service</strong>.</p>
<p>As you probably can imagine, running a distributed system in production is quite <strong>different from running it on your machine</strong>.</p>
<p>The basics are the same: programs running on computers on some Unix-like operating system (Linux, unless you have a picky sysadmin or very specific needs), connected to the Internet. However, the <strong>operational requirements</strong> wildly vary.</p>
<p>Let&apos;s see everything we want our <em>production infrastructure</em> to provide, and how to get there.</p>
<h2 id="12-factor-apps">12-factor apps</h2>
<p>First of all, your code needs to be <strong>adaptable to the environment</strong>. While developing, maybe you&apos;ve been hardcoding URLs and file paths. Maybe you&apos;ve been listening to whatever port directly. That&apos;s not going to fly now.</p>
<p><a href="https://12factor.net/" target="_blank">12-factor</a> is a common <strong>set of conventions</strong> for designing programs to run in modern infrastructure. As with any set of good practices, it&apos;s a guideline rather than holy scripture.</p>
<p>The Web page is actually well-written and should be approachable to newcomers. Go and take a good look before continuing. As always, ask your mentor for help!</p>
<h2 id="versions-coexisting-for-a-while">Versions coexisting for a while</h2>
<p>When you deploy a new version of a service, the new version will coexist with the old one for some time.</p>
<h3 id="graceful-deploys">Graceful deploys</h3>
<p>To keep service disruption to a minimum, a deploy happens in stages:</p>
<ol>
<li>A new process is started with the new version of the code.</li>
<li>We wait for the service to report itself as available, often through health checks.</li>
<li>We start routing new requests to the new process.</li>
<li>We stop routing new requests to the old process.</li>
<li>We wait for ongoing requests to the old process to finish by themselves for some time, and then start closing them in a gradual, controlled manner (<a href="https://12factor.net/disposability" target="_blank">graceful shutdown</a>).</li>
<li>The old process stops, or is forcibly stopped.</li>
<li>Repeat for all instances we want to replace with the new version.</li>
</ol>
<p>If we don&apos;t follow this exact order, there will be intervals in which requests will arrive to unavailable services.</p>
<h3 id="clients-wont-use-the-new-api-yet">Clients won&apos;t use the new API (yet)</h3>
<p>So requests from clients will, for a small interval of time, arrive at both the old version and the new version of the code.</p>
<p>Even when only the new version is left running, <strong>clients will still be consuming the same API</strong>, so the new version must support it. As <a href="../001-programming-a-backend/02-serving-an-api.html#apis-get-old">we&apos;ve seen</a>, your changes must be backwards-compatible.</p>
<h3 id="the-full-deprecation-path">The full deprecation path</h3>
<p>Say we have version A in production, both in clients and servers, and we want to replace it with version B.</p>
<ol>
<li>Deploy a new version of the server that serves both APIs A and B.</li>
<li>Release a new version of the client that only consumes API B.</li>
<li>Wait until no clients of A are left, or until you&apos;re satisfied you can break all old clients left. (This might take years or even never happen.)</li>
<li>Release a new version of the server that only serves API B.</li>
</ol>
<h3 id="data-migrations">Data migrations</h3>
<p>APIs aren&apos;t the only thing that changes. The code handling saving and retrieving data from a database changes too, in a similar manner.</p>
<p>When you deploy a new version of your service, the stored data won&apos;t magically change at the same time to adapt to your new code. Instead, your <strong>new code must be compatible with existing data</strong>.</p>
<p>Making breaking changes will involve an intermediate stage in which you <strong>retrieve data in both the old and new versions</strong>, whatever exists, and <strong>store it in the new version</strong>. Eventually, no data still on the old version will exist, and you&apos;ll be able to delete code that handles it.</p>
<h2 id="staging-environments">Staging environments</h2>
<p>Before facing the public, you probably want to put your backend in an environment that <strong>resembles production</strong> as much as possible, but doesn&apos;t actually affect production. This will give you some extra confidence that your code will actually work.</p>
<p>Such an environment is usually called <em>staging</em> or <em>preproduction</em> (different people mean different things with those terms).</p>
<h3 id="load-testing">Load testing</h3>
<p>A production-like environment is also a good place to <strong>check what happens when load increases</strong>.</p>
<p>You can change load factors (requests per second here and there, request size, entropy (how similar requests are to each other, for a relevant definition of similar), etc.) and also resource allocations independently or in coordination to see how different configurations affect the different parts of your system.</p>
<h2 id="testing-in-production">Testing in production</h2>
<p>Whether you like or not, ultimately your changes will be <strong>tested in production</strong>.</p>
<p>The production environment can display some combination of factors that your testing pipeline hasn&apos;t anticipated that causes your changes to break.</p>
<p>Since this is always a possibility, you need to <strong>plan for it</strong> and try to <strong>reduce service impact</strong> in such scenarios. And, since you have to support this anyway, you can actually take advantage from it and not fret that much over your testing pipeline.</p>
<h3 id="sending-a-canary-down-the-coal-mine">Sending a canary down the coal mine</h3>
<p>A <em>canary release</em> is a first, limited, especially monitored release of your changes so that they only <strong>handle a small portion</strong> of the incoming requests.</p>
<p>This usually means just deploy a few, or even a single, instance of the new version, and let load balancers direct a proportional amount of traffic to it.</p>
<p>If you observe failures related to the canary, you <strong>kill the canary</strong> (if it&apos;s still alive) and, based on the data you&apos;ve gathered from your monitoring, fix your changes and try again.</p>
<p>Otherwise, you gradually deploy to handle more and more of the requests, until the release is complete.</p>
<p>We will discuss at length how to <strong>observe</strong> such failures in future chapters.</p>
<h3 id="rolling-back-bad-releases">Rolling back bad releases</h3>
<p>Even if your changes passed the canary phase, an actual release that starts processes that handles more and more traffic, and replaces more and more of the old processes, can unleash failures due to the increasingly intense environment your changes live in.</p>
<p>When this happens, you need to be able to <strong>quickly deploy the previous version</strong>, to fall back to a (hopefully) stable state.</p>
<p>This process is called a <em>rollback</em> or a <em>revert</em>.</p>
<h2 id="assigning-computing-resources">Assigning computing resources</h2>
<p>Our programs happen to run in actual computers. Actual computers <strong>cost money</strong>, so ideally we want to assign computer resources to the different parts of your system optimally: enough to handle the amount of traffic you expect, but not much more than that.</p>
<p>Load testing and observing how production behaves can help you decide which are those optimal resources for each of your system components.</p>
<h3 id="schedulers">Schedulers</h3>
<p>The art of assigning limited resources to processes with particular demands is called <strong>scheduling</strong>.</p>
<p>Systems such as <a href="https://www.nomadproject.io/" target="_blank">Nomad</a> and <a href="https://kubernetes.io/" target="_blank">Kubernetes</a> implement schedulers that <strong>take your requirements</strong> about the resources you need the and <strong>assign them to the available computing resources</strong>, automatically deploying then in the computers they decide.</p>
<p>Schedulers are often in charge also of monitoring the health of each process, so that a <strong>process that dies is automatically replaced</strong>.</p>
<h2 id="no-single-computer-no-single-datacenter">No single computer, no single datacenter</h2>
<p>Here are two facts of life:</p>
<ul>
<li>A computer that dies takes down all processes running on it.</li>
<li>A datacenter that dies takes down all computers running on it.</li>
</ul>
<p>Thankfully, the recipe for being robust in both scenarios is simple: <strong>don&apos;t put all your eggs in the same basket</strong>.</p>
<p>You should have some replicas or redundant instances of each of your backend services on different datacenters, and, within a datacenter, on different computers.</p>
<p>The problem is, communicating from one datacenter to another comes with <strong>big latencies</strong>, so you probably want to sacrifice some consistency there by only <strong>communicating the essential</strong> and doing so <strong>asynchronously</strong> when possible.</p>
<h2 id="finding-others-in-a-changing-environment">Finding others in a changing environment</h2>
<p>So your scheduler will decide where it will actually run your processes. In fact, it will probably run them itself, taking charge of starting and stopping them, passing configuration to them, etc. It needs to decide which resources to allocate for a process, so it makes sense that it also takes care of actually running the process within its designated resources.</p>
<p>This means that you really can&apos;t predict which <strong>address</strong> any given process will have. How do you get processes to communicate? After all, you&apos;re trying to deploy a distributed system!</p>
<p>This problem is called <em>service discovery</em>, and it involves some number of <em>registries</em>. For example:</p>
<ul>
<li>Redundant backends offering the same service need to register with their reverse proxy/load balancer.</li>
<li>Reverse proxies for a service need to register in some service registry, so that requests to that service reach them.</li>
<li>The outermost layer needs to listen to traffic directed at the IP addresses listed in the public DNS records.</li>
</ul>
<h2 id="adjusting-scale">Adjusting scale</h2>
<p>For a variety of reasons, <strong>traffic goes up and down</strong>. You should <strong>adjust available resources</strong> accordingly.</p>
<p>Observations from production and load testing will help you <strong>predict how resource requirements change</strong> as different traffic patterns change.</p>
<h3 id="auto-scaling">Auto-scaling</h3>
<p><strong>Cloud providers</strong> let you order and dispose of computing resources on-demand, and often do so automatically by monitoring your performance.</p>
<h2 id="a-note-about-deploying-microservices">A note about deploying microservices</h2>
<p>In <a href="../002-distributed-data/04-operation-oriented-databases.html">previous chapters</a> we talked about some of the advantages that a microservices architecture is supposed to provide. We didn&apos;t really discuss its drawbacks.</p>
<p>Well, here they are: as the number of heterogeneous moving parts increase, we need to do more of the stuff presented in this chapter. It&apos;s hard to avoid that operating tens or hundreds or microservices usually result in a <strong>complexity explosion</strong> and quickly becomes a challenge. There&apos;s not really enough tooling in place to handle all this easily, and it remains an unsolved problem.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="01-computers-disappear.html" class="navigation navigation-prev " aria-label="Previous page: Computers disappear">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="03-memory-isnt-infinite.html" class="navigation navigation-next " aria-label="Next page: Memory isn't infinite">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Deploying","level":"1.4.2","depth":2,"next":{"title":"Memory isn't infinite","level":"1.4.3","depth":2,"path":"003-backends-in-the-wild/03-memory-isnt-infinite.md","ref":"003-backends-in-the-wild/03-memory-isnt-infinite.md","articles":[]},"previous":{"title":"Computers disappear","level":"1.4.1","depth":2,"path":"003-backends-in-the-wild/01-computers-disappear.md","ref":"003-backends-in-the-wild/01-computers-disappear.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["anchorjs","mermaid-gb3","livereload"],"pluginsConfig":{"livereload":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"mermaid-gb3":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchorjs":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"003-backends-in-the-wild/02-deploying.md","mtime":"2022-04-29T07:27:32.084Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-05-25T09:07:35.508Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-anchorjs/anchor.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-anchorjs/anchor-style.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mermaid-gb3/book/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    <script src="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.min.js"></script>

    </body>
</html>

